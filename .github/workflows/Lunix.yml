name: Setup KDE Plasma Runner + Ngrok + VNC

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  setup-gui-runner:
    runs-on: ubuntu-latest
    env:
      NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      USERNAME: runner
      PASSWORD: runner

    steps:
      - uses: actions/checkout@v4

      - name: Ensure runner user has sudo
        run: |
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}

      - name: Install KDE Plasma + VNC server
        run: |
          echo ">>> Installing KDE Plasma Desktop + VNC..."
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            kde-plasma-desktop konsole dbus-x11 xorg \
            tigervnc-standalone-server tigervnc-common tigervnc-tools

          mkdir -p /home/${USERNAME}/.vnc
          echo ${PASSWORD} | vncpasswd -f > /home/${USERNAME}/.vnc/passwd
          chmod 600 /home/${USERNAME}/.vnc/passwd
          chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/.vnc

          # KDE startup
          echo "startplasma-x11" > /home/${USERNAME}/.xsession
          chown ${USERNAME}:${USERNAME} /home/${USERNAME}/.xsession

      - name: Install Ngrok
        run: |
          echo ">>> Installing Ngrok..."
          curl -sSL https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz \
            | sudo tar -xz -C /usr/local/bin
          ngrok config add-authtoken ${NGROK_AUTH_TOKEN}

      - name: Start VNC + Ngrok Tunnel
        run: |
          echo ">>> Starting VNC server..."
          sudo -u ${USERNAME} vncserver :1 -geometry 1280x800 -depth 24 -localhost no

          echo ">>> Starting Ngrok TCP tunnel (India region)..."
          nohup ngrok tcp 5901 --region=in > /dev/null 2>&1 &

          sleep 6  # give ngrok time to start

          echo ">>> Fetching Ngrok public address..."
          NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')

          echo "=== CONNECTION INFO ==="
          echo "USERNAME: ${USERNAME}"
          echo "PASSWORD: ${PASSWORD}"
          echo "Ngrok VNC Address:"
          echo "    ${NGROK_URL}"
          echo
          echo ">>> Keeping runner alive..."
          tail -f /dev/null
